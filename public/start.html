<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pago con MODO - Gardenlife</title>
  <script src="https://ecommerce-modal.modo.com.ar/bundle.js"></script>
  <style>
    /* estilo igual */
  </style>
</head>
<body>
  <script>
    if (location.hostname.endsWith('vercel.app')) {
      location.href = `https://gardenlife.com.ar/apps/modo/start.html${location.search}`;
    }
  </script>

  <h1>Pag√° con MODO üí≥</h1>
  <div id="errorBanner"></div>
  <div id="spinner" class="spinner" aria-label="Cargando"></div>
  <p id="phase" class="muted">Preparando pago‚Ä¶</p>
  <p id="status" class="muted"></p>
  <p>Monto: $<span id="amountText">--</span></p>
  <button id="openModo" class="btn">Abrir MODO</button>
  <button id="doneBtn" class="btn">Finalizar</button>
  <pre id="debug"></pre>

  <script>
    const q = new URLSearchParams(location.search);
    const mode = (q.get('mode') || '').toLowerCase();
    const orderNumber = q.get('orderNumber') || '';
    const amountFromUrl = Number(String(q.get('amount') || '0').replace(',', '.'));
    let amount = 0;

    console.log('start.html - Par√°metros recibidos:', { mode, orderNumber, amountFromUrl });

    const PROXY_BASE = '/apps/modo';
    const $ = id => document.getElementById(id);

    function showSpinner(show) { $('spinner').style.display = show ? 'block' : 'none'; }
    function showError(msg) { const el = $('errorBanner'); el.textContent = msg; el.style.display = 'block'; }
    const setStatus = msg => { $('status').textContent = msg || ''; };
    const setPhase = msg => { $('phase').textContent = msg || ''; };
    const showBtns = () => { $('openModo').style.display = 'inline-block'; if (mode !== 'ty') $('doneBtn').style.display = 'inline-block'; };
    const logDebug = obj => {
      try { obj = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2); } catch {}
      const el = $('debug'); el.style.display = 'block'; el.textContent = String(obj).slice(0, 8000);
    };

    async function fetchJSON(url, init) {
      const res = await fetch(url, init);
      const txt = await res.text();
      try { return { ok: res.ok, status: res.status, json: JSON.parse(txt), raw: txt }; }
      catch { return { ok: res.ok, status: res.status, json: null, raw: txt }; }
    }

    async function resolveAmountIfNeeded() {
      if (Number.isFinite(amountFromUrl) && amountFromUrl > 0) {
        amount = amountFromUrl;
        return amount;
      }
      if (orderNumber) {
        setStatus('Consultando monto de la orden‚Ä¶');
        const { ok, json, raw } = await fetchJSON(`${PROXY_BASE}/get-order-amount?orderNumber=${encodeURIComponent(orderNumber)}`);
        if (!ok || !json?.amount) {
          logDebug(raw || json);
          throw new Error('No se pudo obtener el monto de la orden');
        }
        amount = Number(json.amount || 0);
        return amount;
      }
      throw new Error('No se recibi√≥ el monto. Volv√© a la p√°gina anterior e intent√° nuevamente.');
    }

    // resto igual (createPaymentIntention, showModo, etc.)...

  </script>
</body>
</html>
