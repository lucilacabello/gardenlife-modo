<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pago con MODO - Gardenlife</title>
  <script src="https://ecommerce-modal.modo.com.ar/bundle.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 40px; }
    #debug { display:none; white-space: pre-wrap; font-size: 13px; background: #f7f7f7; border:1px solid #ddd; padding:10px; margin-top:20px; text-align:left; }
    #status { margin:10px 0; font-weight: 500; }
    button { background:#2E7D32; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; margin:5px; }
  </style>
</head>
<body>
  <h1>PagÃ¡ con MODO ðŸ’³</h1>
  <p id="phase">Preparando pagoâ€¦</p>
  <p id="status"></p>
  <p>Monto: $<span id="amountText">--</span></p>
  <button id="openModo" style="display:none;">Abrir MODO</button>
  <button id="doneBtn" style="display:none;">Finalizar</button>
  <pre id="debug"></pre>

  <script>
    // Redirigir si se abre directamente desde Vercel
    if (location.hostname.endsWith('vercel.app')) {
      location.href = `https://gardenlife.com.ar/apps/modopay/start${location.search}`;
    }
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const phaseEl  = document.getElementById('phase');
    const statusEl = document.getElementById('status');
    const debugEl  = document.getElementById('debug');
    const amountEl = document.getElementById('amountText');
    const openBtn  = document.getElementById('openModo');
    const doneBtn  = document.getElementById('doneBtn');

    // âœ… App Proxy base
    const PROXY_BASE = '/apps/modopay';

    // Helper para log
    const showDebug = (txt) => {
      try { if (typeof txt === 'object') txt = JSON.stringify(txt, null, 2); } catch {}
      debugEl.style.display = 'block';
      debugEl.textContent = String(txt).slice(0, 4000);
    };
    const setStatus = (msg) => { if (statusEl) statusEl.textContent = msg || ''; };
    const showButtons = () => {
      openBtn.style.display = 'inline-block';
      doneBtn.style.display = 'inline-block';
    };

    // === Contexto de URL ===
    const params = new URLSearchParams(location.search);
    let ctx = {};
    try {
      const b64 = params.get('ctx');
      if (b64) ctx = JSON.parse(decodeURIComponent(escape(atob(b64))));
    } catch {}

    // --- Monto ---
    let amount = Number(params.get('amount'));
    if (!Number.isFinite(amount) || amount <= 0) {
      const ctxTotal = Number(ctx?.total);
      if (Number.isFinite(ctxTotal) && ctxTotal > 0) amount = ctxTotal;
    }
    if (!Number.isFinite(amount) || amount <= 0) amount = 10;
    amount = Number(amount.toFixed(2));
    amountEl.textContent = amount.toFixed(2);

    // === Variables globales ===
    let draftId = params.get('draft_id') || null;
    let checkoutId = null;
    let deeplink = null;
    let qrString = null;

    // === Fetch JSON helper ===
    async function fetchJSON(url, init) {
      const res = await fetch(url, init);
      const text = await res.text();
      try { return { ok: res.ok, status: res.status, json: JSON.parse(text), raw: text }; }
      catch { return { ok: res.ok, status: res.status, json: null, raw: text }; }
    }

    // === 1) Draft Order ===
    async function ensureDraft() {
      if (draftId) return draftId;
      setStatus('Creando borrador del pedidoâ€¦');
      const payload = {
        note: 'Pago con MODO',
        tags: ['modo','qr'],
        customer: ctx.customer || {},
        shipping_address: ctx.shipping_address || {},
        billing_address: ctx.billing_address || {},
        lineItems: Array.isArray(ctx.line_items) && ctx.line_items.length
          ? ctx.line_items
          : [{ title:'Pago MODO', price: amount, quantity: 1 }]
      };
      const { ok, status, json, raw } = await fetchJSON(
        `${PROXY_BASE}/shopify/draft-create`,
        { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }
      );
      if (!ok) throw new Error(`DRAFT_CREATE_FAIL ${status}`);
      draftId = json.draft_id;
      return draftId;
    }

    // === 2) Crear intenciÃ³n de pago ===
    async function createPaymentRequest() {
      setStatus('Creando intenciÃ³n de pagoâ€¦');
      const { ok, status, json, raw } = await fetchJSON(
        `${PROXY_BASE}/modo/payment-request`,
        { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ amount, draft_id: draftId }) }
      );
      if (!ok) throw new Error(`PAYMENT_REQUEST_FAIL ${status}`);
      checkoutId = json.id;
      qrString = json.qr;
      deeplink = typeof json.deeplink === 'string' ? json.deeplink : (json.deeplink?.url || null);
      return json;
    }

    // === 3) Abrir modal de MODO ===
    function openModoModal() {
      if (!checkoutId) return;
      if (phaseEl) phaseEl.textContent = 'Abriendo MODOâ€¦';

      try {
        if (window.ModoSDK && typeof ModoSDK.modoInitPayment === 'function') {
          const origin = location.origin;

          ModoSDK.modoInitPayment({
            version: '2',
            checkoutId,
            qrString,
            deeplink: deeplink ? {
              url: deeplink,
              callbackURL:        `${origin}/cart`,
              callbackURLSuccess: `${origin}/pages/gracias`
            } : undefined,
            callbackURL: `${origin}/pages/gracias`,
            refreshData: async () => {
              const r = await createPaymentRequest();
              return {
                checkoutId: r.id,
                qrString: r.qr,
                deeplink: r.deeplink ? { url: r.deeplink } : undefined
              };
            },
            onSuccess: function () {
              if (draftId) {
                location.href = `/pages/modo-success?draft_id=${encodeURIComponent(draftId)}`;
              } else {
                location.href = `${origin}/pages/gracias`;
              }
            },
            onFailure: function () {
              setStatus('Pago rechazado o fallido.');
            },
            onCancel: function () {
              setStatus('Pago cancelado por el usuario.');
            },
            onClose: function () {
              setStatus('Cerraste el modal de MODO.');
            }
          });
        } else {
          // ðŸ”¸ Fallback QR si no carga el SDK
          setStatus('SDK no disponible. Mostrando QRâ€¦');
          if (qrString) {
            const img = new Image();
            img.alt = 'QR de pago MODO';
            img.style.maxWidth = '260px';
            img.src = `https://chart.googleapis.com/chart?chs=260x260&cht=qr&chl=${encodeURIComponent(qrString)}`;
            (debugEl || document.body).appendChild(img);
          } else if (deeplink) {
            setStatus('Abriendo app MODOâ€¦');
            location.href = deeplink;
          }
        }
      } catch (e) {
        console.error(e);
        setStatus('Error al abrir MODO.');
        showDebug(e?.message || e);
      } finally {
        showButtons();
      }
    }

    // === 4) Poll de estado ===
    async function pollStatus(id, maxSecs = 120) {
      const start = Date.now();
      while (Date.now() - start < maxSecs * 1000) {
        try {
          const r = await fetch(`${PROXY_BASE}/modo/status?id=${encodeURIComponent(id)}`);
          const j = await r.json();
          const s = (j?.status || '').toUpperCase();
          if (s) setStatus(`Estado: ${s}`);
          if (s === 'APPROVED') {
            if (draftId) {
              location.href = `/pages/modo-success?draft_id=${encodeURIComponent(draftId)}`;
            } else {
              location.href = '/pages/gracias';
            }
            return;
          }
        } catch {}
        await new Promise(r => setTimeout(r, 3000));
      }
    }

    function goToSuccess() {
      if (!draftId) return alert('Falta draft_id, volvÃ© a intentar.');
      location.href = `/pages/modo-success?draft_id=${encodeURIComponent(draftId)}`;
    }

    // === Secuencia principal ===
    (async () => {
      try {
        await ensureDraft();
        await createPaymentRequest();
        if (phaseEl) phaseEl.textContent = 'Listo. EscaneÃ¡ el QR o abrÃ­ MODO.';
        openBtn.onclick = () => openModoModal();
        doneBtn.onclick = goToSuccess;
        openModoModal();
        pollStatus(checkoutId).catch(()=>{});
      } catch (e) {
        console.error(e);
        setStatus(e.message);
        showDebug(e);
        showButtons();
      }
    })();
  });
  </script>
</body>
</html>

