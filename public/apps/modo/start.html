<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Pago con MODO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- SDK MODO -->
  <script src="https://ecommerce-modal.modo.com.ar/bundle.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:24px}
    .wrap{max-width:560px;margin:0 auto}
    .muted{color:#666}
    .row{margin-top:16px;display:flex;gap:12px;flex-wrap:wrap}
    .btn{appearance:none;border:0;background:#2E7D32;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer}
    .btn.secondary{background:#455A64}
    .btn:disabled{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Pago con MODO</h1>
    <p class="muted">Monto: <span id="amountText">—</span></p>
    <p id="phase">Estamos generando tu QR / deeplink…</p>
    <div id="status" class="muted"></div>

    <div class="row">
      <button id="openModo" class="btn" style="display:none">Abrir MODO</button>
      <button id="doneBtn" class="btn secondary" style="display:none">Ya pagué / Volver a la tienda</button>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const statusEl  = document.getElementById('status');
    const phaseEl   = document.getElementById('phase');
    const amountEl  = document.getElementById('amountText');
    const openBtn   = document.getElementById('openModo');
    const doneBtn   = document.getElementById('doneBtn');

    // === Params ===
    const params = new URLSearchParams(location.search);
    const rawAmount = params.get('amount');
    const amountNum = Number(rawAmount);
    const amount    = Number.isFinite(amountNum) ? Number(amountNum.toFixed(2)) : 10;
    const draftFromQuery = params.get('draft_id');
    amountEl.textContent = amount.toFixed(2);

    // === Contexto (checkout extension) ===
    let ctx = {};
    try {
      const b64 = params.get('ctx');
      if (b64) ctx = JSON.parse(atob(b64));
    } catch {}

    // App Proxy base
    const BASE = ''; // /apps/modo/...

    let draftId    = draftFromQuery || null;
    let checkoutId = null;
    let deeplink   = null;
    let qrString   = null;

    function setStatus(msg){ statusEl.textContent = msg || ''; }
    function showButtons() {
      if (deeplink) openBtn.style.display='inline-block';
      doneBtn.style.display='inline-block';
    }

    // === 1) Crear Draft Order ===
    async function ensureDraft() {
      if (draftId) return draftId;
      setStatus('Creando borrador del pedido…');

      const payload = {
        note: 'Pago con MODO',
        tags: ['modo','qr'],
        customer: ctx.customer || {},                // { email, first_name, last_name, phone }
        shipping_address: ctx.shipping_address || {},// { address1, city, zip, province, country, phone }
        billing_address: ctx.billing_address || {},
        lineItems: ctx.line_items || [{ title:'Pago MODO', price: amount, quantity: 1 }]
      };

      const r = await fetch(`/apps/modo/api/shopify/draft-create`, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if (!r.ok) throw new Error(`DRAFT_CREATE_FAIL ${r.status}: ${JSON.stringify(j)}`);
      draftId = j.draft_id;
      return draftId;
    }

    // === 2) Crear intención de pago en MODO ===
    async function createPaymentRequest() {
      setStatus('Creando intención de pago…');
      const r = await fetch(`/apps/modo/api/modo/payment-request`, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ amount: amount, draft_id: draftId })
      });
      const j = await r.json();
      if (!r.ok) throw new Error(`PAYMENT_REQUEST_FAIL ${r.status}: ${JSON.stringify(j)}`);
      checkoutId = j.id; qrString = j.qr; deeplink = j.deeplink;
      return j;
    }

    // === 3) Abrir modal MODO ===
    function openModoModal() {
      if (!checkoutId) return;
      phaseEl.textContent = 'Abriendo MODO…';
      try {
        ModoSDK.modoInitPayment({
          version: '2',
          checkoutId,
          qrString,
          deeplink:  deeplink ? { url: deeplink } : undefined,
          callbackURL:        `${location.origin}/cart`,
          callbackURLSuccess: `${location.origin}/`,
          refreshData: async () => {
            const j = await createPaymentRequest();
            return {
              checkoutId: j.id,
              qrString:   j.qr,
              deeplink:   j.deeplink ? { url: j.deeplink } : undefined
            };
          }
        });
      } catch (e) {
        console.error(e); setStatus('No pudimos iniciar MODO. Reintentá.');
      } finally { showButtons(); }
    }

    // === 4) Ir al success ===
    function goToSuccess() {
      if (!draftId) return alert('Falta draft_id, volvé a intentar.');
      location.href = `/pages/modo-success?draft_id=${encodeURIComponent(draftId)}`;
    }

    // === Flow principal ===
    (async () => {
      try {
        await ensureDraft();
        await createPaymentRequest();
        phaseEl.textContent = 'Listo. Escaneá el QR o abrí la app MODO.';
        openBtn.style.display = 'inline-block';
        openBtn.onclick = () => { if (deeplink) location.href = deeplink; openModoModal(); };
        doneBtn.onclick = goToSuccess;
        openModoModal(); // auto-abrir
      } catch (e) {
        console.error(e); phaseEl.textContent = 'Error al preparar el pago.'; setStatus(e.message);
      }
    })();
  });
  </script>
</body>
</html>

