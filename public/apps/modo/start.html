<script src="https://ecommerce-modal.modo.com.ar/bundle.js"></script>
<script>
  const statusEl = document.getElementById('status');
  const amountText = document.getElementById('amountText');

  // lee ?amount= del query (default 10)
  const params = new URLSearchParams(location.search);
  const rawAmount = params.get('amount');
  const amount = Number.isFinite(Number(rawAmount)) ? Number(rawAmount) : 10;
  amountText.textContent = amount.toFixed(2);

  async function createPaymentIntention() {
    const url = `./api/modo/payment-request?amount=${encodeURIComponent(amount)}`;
    const res = await fetch(url, { method: 'POST' });
    if (!res.ok) throw new Error(`PAYMENT_REQUEST_FAIL ${res.status}`);
    const json = await res.json();
    // El backend debe devolver estos tres campos:
    // { id, qr, deeplink }
    return {
      checkoutId: json.id,
      qrString: json.qr,
      deeplink: json.deeplink
    };
  }

  (async () => {
    try {
      const modalData = await createPaymentIntention();
      console.log('MODO checkoutId:', modalData.checkoutId);

      const modalObject = {
        version: '2',
        checkoutId: modalData.checkoutId,
        qrString: modalData.qrString,
        deeplink: { url: modalData.deeplink },
        callbackURL: `${location.origin}/checkout`,        // tu URL real
        callbackURLSuccess: `${location.origin}/thankyou`, // tu URL real
        refreshData: createPaymentIntention
      };

      statusEl.textContent = 'Abriendo MODO…';
      ModoSDK.modoInitPayment(modalObject);
    } catch (e) {
      statusEl.textContent = 'No pudimos iniciar MODO. Reintentá.';
      console.error(e);
    }
  })();
</script>

