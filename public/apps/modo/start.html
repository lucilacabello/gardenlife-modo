<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Pago con MODO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- SDK MODO -->
  <script src="https://ecommerce-modal.modo.com.ar/bundle.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:24px}
    .wrap{max-width:560px;margin:0 auto}
    .muted{color:#666}
    .row{margin-top:16px;display:flex;gap:12px;flex-wrap:wrap}
    .btn{appearance:none;border:0;background:#2E7D32;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer}
    .btn.secondary{background:#455A64}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    pre.err{white-space:pre-wrap;background:#fff3f3;border:1px solid #f6caca;border-radius:6px;padding:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Pago con MODO</h1>
    <p class="muted">Monto: <span id="amountText">‚Äî</span></p>
    <p id="phase">Estamos generando tu QR / deeplink‚Ä¶</p>
    <div id="status" class="muted"></div>
    <pre id="debug" class="err" style="display:none"></pre>

    <div class="row">
      <button id="openModo" class="btn" style="display:none">Abrir MODO</button>
      <button id="doneBtn" class="btn secondary" style="display:none">Ya pagu√© / Volver a la tienda</button>
    </div>
  </div>

<script>
  // ...
  // ‚ö†Ô∏è Us√° SIEMPRE la URL absoluta de tu App Proxy
  const PROXY_BASE = 'https://gardenlife.com.ar/apps/modo';

  async function fetchJSON(url, init) {
    const res = await fetch(url, init);
    const text = await res.text();
    try { return { ok: res.ok, status: res.status, json: JSON.parse(text), raw: text }; }
    catch { return { ok: res.ok, status: res.status, json: null, raw: text }; }
  }

  async function ensureDraft() {
    if (draftId) return draftId;
    setStatus('Creando borrador del pedido‚Ä¶');

    const payload = {
      note: 'Pago con MODO',
      tags: ['modo','qr'],
      customer: ctx.customer || {},
      shipping_address: ctx.shipping_address || {},
      billing_address: ctx.billing_address || {},
      lineItems: Array.isArray(ctx.line_items) && ctx.line_items.length
        ? ctx.line_items
        : [{ title:'Pago MODO', price: amount, quantity: 1 }]
    };

    // üëá Forzado con PROXY_BASE absoluto
    const { ok, status, json, raw } = await fetchJSON(
      `${PROXY_BASE}/api/shopify/draft-create`,
      { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }
    );
    if (!ok) { showDebug(raw || json); throw new Error(`DRAFT_CREATE_FAIL ${status}`); }
    draftId = json.draft_id; return draftId;
  }

  async function createPaymentRequest() {
    setStatus('Creando intenci√≥n de pago‚Ä¶');
    const { ok, status, json, raw } = await fetchJSON(
      `${PROXY_BASE}/api/modo/payment-request?debug=1`,
      { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ amount, draft_id: draftId }) }
    );
    if (!ok) { showDebug(raw || json); throw new Error(`PAYMENT_REQUEST_FAIL ${status}`); }
    checkoutId = json.id; qrString = json.qr; deeplink = typeof json.deeplink === 'string' ? json.deeplink : (json.deeplink?.url || null);
    return json;
  }
  // ...
</script>

</body>
</html>

