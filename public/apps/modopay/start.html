<!-- SDK de MODO (PROD) -->
<script src="https://ecommerce-modal.modo.com.ar/bundle.js"></script>

<body style="font-family: sans-serif; text-align: center; margin: 40px;">
  <h1>Pag√° con MODO üí≥</h1>
  <p id="phase">Preparando pago‚Ä¶</p>
  <p id="status"></p>
  <p>Monto: $<span id="amountText">--</span></p>
  <button id="openModo" style="display:none;">Abrir MODO</button>
  <button id="doneBtn" style="display:none;">Finalizar</button>
  <pre id="debug" style="display:none; white-space:pre-wrap; font-size:13px; background:#f7f7f7; border:1px solid #ddd; padding:10px; margin-top:20px; text-align:left;"></pre>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const phaseEl  = document.getElementById('phase');
  const statusEl = document.getElementById('status');
  const debugEl  = document.getElementById('debug');
  const amountEl = document.getElementById('amountText');
  const openBtn  = document.getElementById('openModo');
  const doneBtn  = document.getElementById('doneBtn');

  const PROXY_BASE = '/apps/modopay'; // tu proxy base

  const params = new URLSearchParams(location.search);
  const amount = Number(params.get('amount') || '10');
  amountEl.textContent = amount.toFixed(2);

  let draftId = params.get('draft_id') || null;
  let checkoutId = null, deeplink = null, qrString = null;

  const setStatus = msg => { statusEl.textContent = msg || ''; };
  const showButtons = () => { openBtn.style.display = doneBtn.style.display = 'inline-block'; };

  async function fetchJSON(url, init) {
    const res = await fetch(url, init);
    const txt = await res.text();
    try { return { ok: res.ok, status: res.status, json: JSON.parse(txt), raw: txt }; }
    catch { return { ok: res.ok, status: res.status, json: null, raw: txt }; }
  }

  async function ensureDraft() {
    if (draftId) return draftId;
    setStatus('Creando borrador...');
    const payload = { note: 'Pago con MODO', tags:['modo','qr'], lineItems:[{title:'Pago MODO', price:amount, quantity:1}] };
    const { ok, json } = await fetchJSON(`${PROXY_BASE}/shopify/draft-create`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
    });
    if (!ok) throw new Error('Error creando borrador');
    draftId = json.draft_id;
    return draftId;
  }

  async function createPayment() {
    setStatus('Creando intenci√≥n de pago...');
    const { ok, json } = await fetchJSON(`${PROXY_BASE}/modo/payment-request`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ amount, draft_id: draftId })
    });
    if (!ok) throw new Error('Error creando pago');
    checkoutId = json.id;
    qrString = json.qr;
    deeplink = json.deeplink?.url || json.deeplink;
  }

  function openModoModal() {
    if (!checkoutId) return;
    try {
      ModoSDK.modoInitPayment({
        version: '2',
        checkoutId,
        qrString,
        deeplink: deeplink ? { url: deeplink } : undefined,
        callbackURL: `${location.origin}/cart`,
        callbackURLSuccess: `${location.origin}/pages/gracias`
      });
    } catch (e) {
      setStatus('No se pudo abrir el modal.');
      console.error(e);
    } finally {
      showButtons();
    }
  }

  try {
    await ensureDraft();
    await createPayment();
    phaseEl.textContent = 'Listo. Escane√° el QR o abr√≠ la app MODO.';
    openModoModal();
  } catch (e) {
    console.error(e);
    setStatus(e.message);
    showButtons();
  }
});
</script>
</body>
