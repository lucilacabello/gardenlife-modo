import {
  reactExtension,
  BlockStack,
  Text,
  Button,
  Banner,
  useExtensionApi,
  useEmail,
  useShippingAddress,
  useDeliveryGroups,
  useBuyerJourneyIntercept,
} from '@shopify/ui-extensions-react/checkout';

export default reactExtension('purchase.checkout.block.render', () => <ModoPay />);

function ModoPay() {
  const { checkout } = useExtensionApi();
  const { email } = useEmail();
  const { shippingAddress } = useShippingAddress();
  const { deliveryGroups } = useDeliveryGroups();

  const PROXY_BASE = "/apps/modo";

  const now = new Date();
  const promo = now >= new Date('2025-11-30T00:00:00-03:00') && now <= new Date('2025-12-02T23:59:59-03:00');
  const REINTEGRO = 20;
  const btnLabel = promo ? `Pagar con MODO — ${REINTEGRO}% de reintegro` : 'Pagar con MODO';

  // Monto seguro
  const rawTotal = Number(checkout?.totalAmount?.amount ?? 0);
  const amount = Number.isFinite(rawTotal) && rawTotal > 0 ? rawTotal : 0;

  // Validaciones
  const hasEmail = !!email?.address;
  const sa = shippingAddress || {};
  const hasAddress =
    !!sa?.firstName && !!sa?.lastName && !!sa?.address1 &&
    !!sa?.city && !!sa?.postalCode && !!sa?.countryCode &&
    (!!sa?.provinceCode || !!sa?.province);

  const hasShippingSelection = Array.isArray(deliveryGroups)
    ? deliveryGroups.some(g => g?.selectedDeliveryOption?.handle)
    : false;

  const selectedGroup = Array.isArray(deliveryGroups)
    ? deliveryGroups.find(g => g?.selectedDeliveryOption?.handle)
    : null;

  const optTitle = (selectedGroup?.selectedDeliveryOption?.title || '').toLowerCase();
  const isPickup = optTitle.includes('retiro') || optTitle.includes('pickup') || optTitle.includes('retirar');

  const isReady = hasEmail && hasShippingSelection && (isPickup || hasAddress);
  const isPayable = amount > 0;
  const canPay = isReady && isPayable;

  const missing = [];
  if (!hasEmail) missing.push('Ingresá tu email.');
  if (!hasShippingSelection) missing.push('Elegí un método de envío o retiro.');
  if (!isPickup && !hasAddress) missing.push('Completá la dirección de envío.');
  if (!isPayable) missing.push('El total debe ser mayor a $0.');

  useBuyerJourneyIntercept(({ canBlockProgress }) => {
    if (!isReady || !isPayable) {
      return {
        behavior: canBlockProgress ? 'block' : 'allow',
        reason: 'Completá email, dirección y método de envío antes de pagar con MODO',
        errors: missing.map(m => ({ message: m })),
      };
    }
    return { behavior: 'allow' };
  });

  async function handlePay() {
    // Contexto para el backend (opcional)
    const ctx = (() => {
      const payload = {
        customer: { email: email?.address || '' },
        shipping_address: sa,
        is_pickup: isPickup,
      };
      return btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
    })();

    // 1) Crear Draft Order antes de salir (vía App Proxy)
    let draftId = null;
    try {
      const resp = await fetch(`${PROXY_BASE}/shopify/draft-create`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          note: 'Pago con MODO',
          tags: ['modo','qr'],
          amount: Number(Math.max(0, amount || 0).toFixed(2)),
          ctx
        })
      });
      const j = await resp.json();
      if (resp.ok && j?.draft_id) draftId = j.draft_id;
    } catch (e) {
      // si falla, start.html hará ensureDraft() como fallback
    }

    // 2) Redirigir MISMA PESTAÑA al flujo QR
    const href =
      `${PROXY_BASE}/start.html?amount=${encodeURIComponent(Math.max(0, amount || 0).toFixed(2))}` +
      `${draftId ? `&draft_id=${encodeURIComponent(draftId)}` : ''}` +
      `&ctx=${encodeURIComponent(ctx)}`;

    (typeof window !== 'undefined' ? (window.top || window) : { location: { href: '' } }).location.href = href;
  }

  return (
    <BlockStack spacing="tight">
      <Text size="medium" emphasis="bold">MODO y Apps Bancarias</Text>

      {promo && (
        <Banner status="info" title="Promo Cyber Monday">
          Pagá con MODO y recibí {REINTEGRO}% de reintegro.
        </Banner>
      )}

      {!canPay ? (
        <>
          <Banner status="critical" title="Faltan datos para pagar con MODO">
            <ul style={{ marginLeft: 16 }}>
              {missing.map(m => <li key={m}>{m}</li>)}
            </ul>
          </Banner>
          <Button kind="primary" disabled>{btnLabel}</Button>
        </>
      ) : (
        <Button kind="primary" onPress={handlePay}>{btnLabel}</Button>
      )}
    </BlockStack>
  );
}
